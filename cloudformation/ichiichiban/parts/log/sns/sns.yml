---
AWSTemplateFormatVersion: 2010-09-09
Description:
  Setting up Log abnormality notification
Parameters:
  ProductName:
    Type       : String
    Description: Product Name (Ex. MansionValue)
    MinLength  : 1
  Environment:
    Type         : String
    Default      : Stg
    AllowedValues:
      - Stg
      - Prod
    Description  : Select Environment
    MinLength    : 1
  LogGroupArnList:
    Type       : String
    Description: List of log group ARN
    MinLength  : 1
Resources:
  # ---------------------------------------------------------------#
  # Create Log SNS Topic
  # ---------------------------------------------------------------#
  LogSnsTopic:
    Type      : AWS::CloudFormation::Stack
    Properties:
      Parameters:
        TopicDisplayName: !Sub "${ProductName}-${Environment} Log"
        TopicName       : !Sub "${ProductName}-${Environment}-Log-Topic"
      TemplateURL: ./../../sns/topic.yml
  # ---------------------------------------------------------------#
  # Create Log Slack notification Lambda
  # ---------------------------------------------------------------#
  LogSlackNotificationLambdaExecutionRole:
    Type      : AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ResourceArnList: !Ref LogGroupArnList
      TemplateURL: ./slack-notification-lambda/lambda-execution-role.yml
  LogSlackNotificationLambda:
    Type      : AWS::CloudFormation::Stack
    Properties:
      Parameters:
        Environment           : !Ref Environment
        LambdaCode            : ./../log/sns/slack-notification-lambda/lambda-function
        LambdaDescription     : !Sub "${ProductName}-${Environment} Log Slack Notification Lambda"
        LambdaHandler         : realnetplus-log-slack-notification.lambda_handler
        LambdaExecutionRoleArn: !GetAtt LogSlackNotificationLambdaExecutionRole.Outputs.LambdaExecutionRoleArn
        TopicArn              : !GetAtt LogSnsTopic.Outputs.SnsTopicArn
      TemplateURL: ./../../sns/slack-notification-lambda-function.yml
  # ---------------------------------------------------------------#
  # Create Log SNS Subscription
  # ---------------------------------------------------------------#
  LogLambdaSubscription:
    Type      : AWS::CloudFormation::Stack
    Properties:
      Parameters:
        LambdaArn: !GetAtt LogSlackNotificationLambda.Outputs.LogSlackNotificationLambdaFunctionArn
        TopicArn : !GetAtt LogSnsTopic.Outputs.SnsTopicArn
      TemplateURL: ./../../sns/lambda-subscription.yml
Outputs:
  LogSnsTopicArn:
    Description: The ARN of log SNS topic
    Value      : !GetAtt LogSnsTopic.Outputs.SnsTopicArn
  LogSnsTopicName:
    Description: The Name of log SNS topic
    Value      : !GetAtt LogSnsTopic.Outputs.SnsTopicName
  LogSlackNotificationLambdaFunctionName:
    Description: The name of log slack notification lambda
    Value      : !GetAtt LogSlackNotificationLambda.Outputs.LogSlackNotificationLambdaFunctionName
  LogSlackNotificationLambdaFunctionArn:
    Description: The ARN of log slack notification lambda
    Value      : !GetAtt LogSlackNotificationLambda.Outputs.LogSlackNotificationLambdaFunctionArn