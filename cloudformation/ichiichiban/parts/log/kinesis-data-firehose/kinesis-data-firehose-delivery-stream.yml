---
AWSTemplateFormatVersion: 2010-09-09
Description:
  Setting up Log Kinesis Data Firehose
Parameters:
  Environment:
    Type         : String
    Default      : Stg
    AllowedValues:
      - Stg
      - Prod
    Description  : Select Environment
    MinLength    : 1
  BucketArn:
    Type       : String
    Description: S3 bucket ARN
    MinLength  : 1
  FirehoseLogGroupName:
    Type       : String
    Description: Firehose Log Group Name
    MinLength  : 1
  FirehoseLogStreamName:
    Type       : String
    Description: Log Stream Name
    MinLength  : 1
  ServiceName:
    Type       : String
    Description: Service Name (Ex. Api, Web, Batch)
    MinLength  : 1
  RoleArn:
    Type       : String
    Description: Role ARN
    MinLength  : 1
Resources:
  # ---------------------------------------------------------------#
  # Create Log Kinesis Data Firehose
  # ---------------------------------------------------------------#
  # https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-kinesisfirehose-deliverystream.html
  LogKinesisDataFirehoseDeliveryStream:
    Type      : AWS::KinesisFirehose::DeliveryStream
    Properties:
      DeliveryStreamType        : DirectPut
      S3DestinationConfiguration:
        BucketARN               : !Ref BucketArn
        BufferingHints          :
          IntervalInSeconds: 60
          SizeInMBs        : 5
        CloudWatchLoggingOptions:
          Enabled      : true
          LogGroupName : !Ref FirehoseLogGroupName
          LogStreamName: !Ref FirehoseLogStreamName
        CompressionFormat       : GZIP
        ErrorOutputPrefix       : !Sub "KinesisDataFirehose/${Environment}/${ServiceName}/!{firehose:error-output-type}/!{timestamp:yyyy/MM/dd}"
        Prefix                  : !Sub "KinesisDataFirehose/${Environment}/${ServiceName}/!{timestamp:yyyy/MM/dd}"
        RoleARN                 : !Ref RoleArn
Outputs:
  LogKinesisDataFirehoseDeliveryStreamName:
    Description: The name of Log Kinesis Data Firehose Delivery Stream
    Value      : !Ref LogKinesisDataFirehoseDeliveryStream
  LogKinesisDataFirehoseDeliveryStreamArn:
    Description: The ARN of Log Kinesis Data Firehose Delivery Stream
    Value      : !GetAtt LogKinesisDataFirehoseDeliveryStream.Arn