---
AWSTemplateFormatVersion: 2010-09-09
Description:
  Setting up CloudWatch logs and alarm
Parameters:
  ProductName:
    Type       : String
    Description: Product Name (Ex. MansionValue)
    MinLength  : 1
  Environment:
    Type         : String
    Default      : Stg
    AllowedValues:
      - Stg
      - Prod
    Description  : Select Environment
    MinLength    : 1
  RetentionInDays:
    Type       : Number
    Description: Number of days to keep logs
    MinValue   : 3
    Default    : 3
Resources:
  # ---------------------------------------------------------------#
  # Create Log Groups
  # ---------------------------------------------------------------#
  LogGroups:
    Type      : AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ApiLogGroupName  : !Sub "${ProductName}-${Environment}-Api"
        WebLogGroupName  : !Sub "${ProductName}-${Environment}-Web"
        BatchLogGroupName: !Sub "${ProductName}-${Environment}-Batch"
        RetentionInDays  : !Ref RetentionInDays
      TemplateURL: ./log-group/log-groups.yml
  # ---------------------------------------------------------------#
  # Create Log Kinesis Data Firehoses
  # ---------------------------------------------------------------#
  LogKinesisDataFirehoses:
    Type      : AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ProductName: !Ref ProductName
        Environment: !Ref Environment
        BucketArn  : arn:aws:s3:::log.realnet-plus
      TemplateURL: ./kinesis-data-firehose/kinesis-data-firehoses.yml
  # ---------------------------------------------------------------#
  # Create Log Subscription Filters
  # ---------------------------------------------------------------#
  LogSubscriptionFilters:
    Type      : AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ProductName        : !Ref ProductName
        Environment        : !Ref Environment
        ApiDestinationArn  : !GetAtt LogKinesisDataFirehoses.Outputs.ApiLogKinesisDataFirehoseDeliveryStreamArn
        ApiLogGroupName    : !GetAtt LogGroups.Outputs.ApiLogGroupName
        WebDestinationArn  : !GetAtt LogKinesisDataFirehoses.Outputs.WebLogKinesisDataFirehoseDeliveryStreamArn
        WebLogGroupName    : !GetAtt LogGroups.Outputs.WebLogGroupName
        BatchDestinationArn: !GetAtt LogKinesisDataFirehoses.Outputs.BatchLogKinesisDataFirehoseDeliveryStreamArn
        BatchLogGroupName  : !GetAtt LogGroups.Outputs.BatchLogGroupName
      TemplateURL: ./log-subscription-filter/log-subscription-filters.yml
  # ---------------------------------------------------------------#
  # Create Log Metric Filters
  # ---------------------------------------------------------------#
  LogMetricFilters:
    Type      : AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ApiLogGroupName     : !GetAtt LogGroups.Outputs.ApiLogGroupName
        ApiMetricNamespace  : !Sub "${ProductName}-${Environment}-Api"
        WebLogGroupName     : !GetAtt LogGroups.Outputs.WebLogGroupName
        WebMetricNamespace  : !Sub "${ProductName}-${Environment}-Web"
        BatchLogGroupName   : !GetAtt LogGroups.Outputs.BatchLogGroupName
        BatchMetricNamespace: !Sub "${ProductName}-${Environment}-Batch"
      TemplateURL: ./log-metric-filter/log-metric-filters.yml
  # ---------------------------------------------------------------#
  # Create Log Alarm Actions (SNS Topic and Subscription)
  # ---------------------------------------------------------------#
  LogSns:
    Type      : AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ProductName    : !Ref ProductName
        Environment    : !Ref Environment
        LogGroupArnList:
          !Join
            - ","
            - - !GetAtt LogGroups.Outputs.ApiLogGroupArn
              - !GetAtt LogGroups.Outputs.WebLogGroupArn
              - !GetAtt LogGroups.Outputs.BatchLogGroupArn
      TemplateURL: ./sns/sns.yml
  # ---------------------------------------------------------------#
  # Create Log Alarm
  # ---------------------------------------------------------------#
  LogAlarms:
    Type      : AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ProductName         : !Ref ProductName
        Environment         : !Ref Environment
        AlarmActionArn      : !GetAtt LogSns.Outputs.LogSnsTopicArn
        ApiMetricNamespace  : !Sub "${ProductName}-${Environment}-Api"
        WebMetricNamespace  : !Sub "${ProductName}-${Environment}-Web"
        BatchMetricNamespace: !Sub "${ProductName}-${Environment}-Batch"
      TemplateURL: ./alarm/alarms.yml
  # ---------------------------------------------------------------#
  # Create Topic Policy
  # ---------------------------------------------------------------#
  LogSnsTopicPolicy:
    Type      : AWS::CloudFormation::Stack
    Properties:
      Parameters:
        TopicArn             : !GetAtt LogSns.Outputs.LogSnsTopicArn
        ApiLogAlarmErrorArn  : !GetAtt LogAlarms.Outputs.ApiLogAlarmErrorArn
        ApiLogAlarmWarnArn   : !GetAtt LogAlarms.Outputs.ApiLogAlarmWarnArn
        ApiLogAlarmFatalArn  : !GetAtt LogAlarms.Outputs.ApiLogAlarmFatalArn
        WebLogAlarmErrorArn  : !GetAtt LogAlarms.Outputs.WebLogAlarmErrorArn
        WebLogAlarmWarnArn   : !GetAtt LogAlarms.Outputs.WebLogAlarmWarnArn
        WebLogAlarmFatalArn  : !GetAtt LogAlarms.Outputs.WebLogAlarmFatalArn
        BatchLogAlarmErrorArn: !GetAtt LogAlarms.Outputs.BatchLogAlarmErrorArn
        BatchLogAlarmWarnArn : !GetAtt LogAlarms.Outputs.BatchLogAlarmWarnArn
        BatchLogAlarmFatalArn: !GetAtt LogAlarms.Outputs.BatchLogAlarmFatalArn
      TemplateURL: ./sns/topic-policy.yml
Outputs:
  ApiLogGroupName:
    Description: The name of Api log group
    Value      : !GetAtt LogGroups.Outputs.ApiLogGroupName
  ApiLogGroupArn:
    Description: The ARN of Api log group
    Value      : !GetAtt LogGroups.Outputs.ApiLogGroupArn
  WebLogGroupName:
    Description: The name of Web log group
    Value      : !GetAtt LogGroups.Outputs.WebLogGroupName
  WebLogGroupArn:
    Description: The ARN of Web log group
    Value      : !GetAtt LogGroups.Outputs.WebLogGroupArn
  BatchLogGroupName:
    Description: The name of Batch log group
    Value      : !GetAtt LogGroups.Outputs.BatchLogGroupName
  BatchLogGroupArn:
    Description: The ARN of Batch log group
    Value      : !GetAtt LogGroups.Outputs.BatchLogGroupArn